{% extends "base.html" %}
{% block title %}Vacations IADEs{% endblock %}
{% block content %}
    <div class="container">
        {% if message %}
            <div class="row">
                <div class="col-lg-12">
                    <div class="alert alert-primary" role="alert">
                        {{ message }}
                    </div>
                </div>
            </div>
        {% endif %}
        <div class="card mt-2">
            <div class="card-header h4"><strong>Calendrier des vacations IADEs</strong>
                <a href="{% url 'vacation' %}" role="button" class="btn btn-primary float-right">Rafraichir</a>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-lg-12">
                        <div id="calendar"></div>
                    </div>
                </div>
            </div>
        </div>
        <div class="card mt-2">
            <div class="card-header h4"><strong>Liste des vacations IADEs</strong></div>
            <div class="card-body">
                <div class="row">
                    <div class="col-lg-12">
                        <table class="table table-striped table-hover table-sm" id="repart-table">
                            <thead>
                            <tr>
                                <th>Date</th>
                                <th>DÃ©but</th>
                                <th>Fin</th>
                                <th>Commentaires</th>
                                <th>Actions</th>
                            </tr>
                            </thead>
                            <tbody>
                            {% include 'vacations/partial_vac_list.html' %}
                            </tbody>
                        </table>
                        <nav aria-label="Page navigation">
                            <ul class="pagination justify-content-center">

                                {% if vacations.has_previous %}
                                    <li class="page-item"><a class="page-link fa fa-fast-backward" aria-hidden="true"
                                                             href="?page=1"></a></li>
                                    <li class="page-item"><a class="page-link fa fa-backward" aria-hidden="true"
                                                             href="?page={{ vacations.previous_page_number }}"></a></li>
                                {% endif %}
                                <li class="page-item mt-1 small">&emsp;Page {{ vacations.number }}
                                    de {{ vacations.paginator.num_pages }}&emsp;
                                </li>
                                {% if vacations.has_next %}
                                    <li class="page-item small"><a class="page-link fa fa-forward" aria-hidden="true"
                                                                   href="?page={{ vacations.next_page_number }}"></a></li>
                                    <li class="page-item small"><a class="page-link fa fa-fast-forward"
                                                                   aria-hidden="true"
                                                                   href="?page={{ vacations.paginator.num_pages }}"></a>
                                    </li>
                                {% endif %}
                            </ul>
                        </nav>
                    </div>
                </div>
            </div>
        </div>
    </div>
{% endblock %}
{% block modal %}
    <div class="modal fade" id="modal-vac">
        <div class="modal-dialog">
            <div class="modal-content"></div>
        </div>
    </div>
{% endblock modal %}
{% block script %}
    <script>
        $(document).ready(function () {
            $('#calendar').fullCalendar({
                timeZone: 'Europe/Paris',
                defaultView: 'month',
                selectHelper: true,
                eventBackgroundColor: '#A52A2A',
                aspectRatio: 2.8,
                eventTextColor: '#f0ffff',
                height: 'auto',
                header: {
                    left: 'prevYear,nextYear',
                    center: 'today title prev,next',
                    right: 'month,basicWeek,basicDay,listMonth'
                },
                buttonText: {
                    listWeek: 'Week',
                    listMonth: 'Liste du mois'
                },
                defaultDate: Date.now(),
                locale: 'fr',
                buttonIcons: true, // show the prev/next text
                weekNumbers: true,
                navLinks: true, // can click day/week names to navigate views
                editable: true,
                eventLimit: true, // allow "more" link when too many events
                events: '/vac/events.json',
                themeSystem: 'standard',
                selectable: true,
                select: function (start, end, jsEvent, view) {
                    var startday = start.format("DDMMYYYYHHMMSS");
                    var endday = end.format("DDMMYYYYHHMMSS");
                    window.location.href = '/vac/create/' + startday + '/' + endday;
                },
                eventClick: function (event) {
                    var id = event.id;
                    window.location.href = '/vac/update/' + id;
                },
            });
        });
    </script>
    <script>
        $(function () {

            /* Functions */

            var loadForm = function () {
                var btn = $(this);
                $.ajax({
                    url: btn.attr("data-url"),
                    type: 'get',
                    dataType: 'json',
                    beforeSend: function () {
                        $("#modal-vac .modal-content").html("");
                        $("#modal-vac").modal("show");
                    },
                    success: function (data) {
                        $("#modal-vac .modal-content").html(data.html_form);
                    }
                });
            };

            var saveForm = function () {
                var form = $(this);
                $.ajax({
                    url: form.attr("action"),
                    data: form.serialize(),
                    type: form.attr("method"),
                    dataType: 'json',
                    success: function (data) {
                        if (data.form_is_valid) {
                            $("#vac-table tbody").html(data.html_vac_list);
                            $("#modal-vac").modal("hide");
                        } else {
                            $("#modal-vac .modal-content").html(data.html_form);
                        }
                    }
                });
                return false;
            };


            /* Binding */

            // Update repart
            $("#vac-table").on("click", ".js-view-vac", loadForm);
            $("#modal-vac").on("submit", ".js-vac-update-form", saveForm);

            // Delete repart
            $("#vac-table").on("click", ".js-delete-vac", loadForm);
            $("#modal-vac").on("submit", ".js-vac-delete-form", saveForm);

        });
    </script>
{% endblock %}
